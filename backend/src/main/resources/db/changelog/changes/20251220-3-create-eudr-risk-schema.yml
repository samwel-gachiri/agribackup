databaseChangeLog:
  - changeSet:
      id: create-country-risk-matrix-table
      author: EUDR Implementation
      preConditions:
        - onFail: MARK_RAN
        - not:
            - tableExists:
                tableName: country_risk_matrix
      changes:
        - createTable:
            tableName: country_risk_matrix
            columns:
              - column:
                  name: country_code
                  type: VARCHAR(3)
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: country_name
                  type: VARCHAR(100)
                  constraints:
                    nullable: false
              - column:
                  name: risk_level
                  type: VARCHAR(20)
                  constraints:
                    nullable: false
              - column:
                  name: risk_justification
                  type: TEXT
              - column:
                  name: last_updated
                  type: TIMESTAMP
                  constraints:
                    nullable: false
              - column:
                  name: updated_by
                  type: VARCHAR(36)
                  constraints:
                    nullable: false
        - createIndex:
            tableName: country_risk_matrix
            indexName: idx_country_risk_level
            columns:
              - column:
                  name: risk_level
        - createIndex:
            tableName: country_risk_matrix
            indexName: idx_country_risk_updated
            columns:
              - column:
                  name: last_updated

  - changeSet:
      id: create-deforestation-alerts-table
      author: EUDR Implementation
      preConditions:
        - onFail: MARK_RAN
        - not:
            - tableExists:
                tableName: deforestation_alerts
      changes:
        - createTable:
            tableName: deforestation_alerts
            columns:
              - column:
                  name: alert_id
                  type: VARCHAR(36)
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: production_unit_id
                  type: VARCHAR(36)
                  constraints:
                    nullable: false
              - column:
                  name: alert_type
                  type: VARCHAR(50)
                  constraints:
                    nullable: false
              - column:
                  name: alert_geometry
                  type: POINT
              - column:
                  name: latitude
                  type: DECIMAL(10,8)
                  constraints:
                    nullable: false
              - column:
                  name: longitude
                  type: DECIMAL(11,8)
                  constraints:
                    nullable: false
              - column:
                  name: alert_date
                  type: TIMESTAMP
                  constraints:
                    nullable: false
              - column:
                  name: confidence
                  type: DECIMAL(5,4)
                  constraints:
                    nullable: false
              - column:
                  name: severity
                  type: VARCHAR(20)
                  constraints:
                    nullable: false
              - column:
                  name: distance_from_unit
                  type: DECIMAL(10,2)
                  constraints:
                    nullable: false
              - column:
                  name: source
                  type: VARCHAR(100)
                  constraints:
                    nullable: false
              - column:
                  name: source_id
                  type: VARCHAR(100)
              - column:
                  name: metadata
                  type: TEXT
              - column:
                  name: hedera_transaction_id
                  type: VARCHAR(100)
              - column:
                  name: hedera_hash
                  type: VARCHAR(100)
              - column:
                  name: created_at
                  type: TIMESTAMP
              - column:
                  name: is_reviewed
                  type: BOOLEAN
                  defaultValue: false
                  constraints:
                    nullable: false
              - column:
                  name: reviewed_at
                  type: TIMESTAMP
              - column:
                  name: reviewer_id
                  type: VARCHAR(36)
              - column:
                  name: review_notes
                  type: TEXT
        - addForeignKeyConstraint:
            baseTableName: deforestation_alerts
            baseColumnNames: production_unit_id
            referencedTableName: production_units
            referencedColumnNames: unit_id
            constraintName: fk_deforestation_alerts_unit
        - createIndex:
            tableName: deforestation_alerts
            indexName: idx_deforestation_alerts_unit
            columns:
              - column:
                  name: production_unit_id
        - createIndex:
            tableName: deforestation_alerts
            indexName: idx_deforestation_alerts_date
            columns:
              - column:
                  name: alert_date
        - createIndex:
            tableName: deforestation_alerts
            indexName: idx_deforestation_alerts_type
            columns:
              - column:
                  name: alert_type
        - createIndex:
            tableName: deforestation_alerts
            indexName: idx_deforestation_alerts_severity
            columns:
              - column:
                  name: severity
        - createIndex:
            tableName: deforestation_alerts
            indexName: idx_deforestation_alerts_source
            columns:
              - column:
                  name: source
        - createIndex:
            tableName: deforestation_alerts
            indexName: idx_deforestation_alerts_reviewed
            columns:
              - column:
                  name: is_reviewed

  - changeSet:
      id: create-mitigation-workflows-table
      author: EUDR Implementation
      preConditions:
        - onFail: MARK_RAN
        - not:
            - tableExists:
                tableName: mitigation_workflows
      changes:
        - createTable:
            tableName: mitigation_workflows
            columns:
              - column:
                  name: workflow_id
                  type: VARCHAR(36)
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: batch_id
                  type: VARCHAR(36)
                  constraints:
                    nullable: false
              - column:
                  name: risk_level
                  type: VARCHAR(20)
                  constraints:
                    nullable: false
              - column:
                  name: status
                  type: VARCHAR(20)
                  defaultValue: PENDING
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: TIMESTAMP
                  defaultValueComputed: CURRENT_TIMESTAMP
                  constraints:
                    nullable: false
              - column:
                  name: created_by
                  type: VARCHAR(36)
                  constraints:
                    nullable: false
              - column:
                  name: completed_at
                  type: TIMESTAMP
              - column:
                  name: completion_notes
                  type: TEXT
              - column:
                  name: hedera_transaction_id
                  type: VARCHAR(100)
        - addForeignKeyConstraint:
            baseTableName: mitigation_workflows
            baseColumnNames: batch_id
            referencedTableName: eudr_batches
            referencedColumnNames: batch_id
            constraintName: fk_mitigation_workflows_batch
        - createIndex:
            tableName: mitigation_workflows
            indexName: idx_mitigation_workflows_batch
            columns:
              - column:
                  name: batch_id
        - createIndex:
            tableName: mitigation_workflows
            indexName: idx_mitigation_workflows_status
            columns:
              - column:
                  name: status
        - createIndex:
            tableName: mitigation_workflows
            indexName: idx_mitigation_workflows_risk
            columns:
              - column:
                  name: risk_level

  - changeSet:
      id: create-mitigation-actions-table
      author: EUDR Implementation
      preConditions:
        - onFail: MARK_RAN
        - not:
            - tableExists:
                tableName: mitigation_actions
      changes:
        - createTable:
            tableName: mitigation_actions
            columns:
              - column:
                  name: action_id
                  type: VARCHAR(36)
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: workflow_id
                  type: VARCHAR(36)
                  constraints:
                    nullable: false
              - column:
                  name: action_type
                  type: VARCHAR(50)
                  constraints:
                    nullable: false
              - column:
                  name: description
                  type: TEXT
                  constraints:
                    nullable: false
              - column:
                  name: status
                  type: VARCHAR(20)
                  defaultValue: PENDING
                  constraints:
                    nullable: false
              - column:
                  name: assigned_to
                  type: VARCHAR(36)
              - column:
                  name: due_date
                  type: DATE
              - column:
                  name: created_at
                  type: TIMESTAMP
                  defaultValueComputed: CURRENT_TIMESTAMP
                  constraints:
                    nullable: false
              - column:
                  name: completed_at
                  type: TIMESTAMP
              - column:
                  name: completion_evidence
                  type: TEXT
              - column:
                  name: hedera_transaction_id
                  type: VARCHAR(100)
        - addForeignKeyConstraint:
            baseTableName: mitigation_actions
            baseColumnNames: workflow_id
            referencedTableName: mitigation_workflows
            referencedColumnNames: workflow_id
            constraintName: fk_mitigation_actions_workflow
        - createIndex:
            tableName: mitigation_actions
            indexName: idx_mitigation_actions_workflow
            columns:
              - column:
                  name: workflow_id
        - createIndex:
            tableName: mitigation_actions
            indexName: idx_mitigation_actions_status
            columns:
              - column:
                  name: status
        - createIndex:
            tableName: mitigation_actions
            indexName: idx_mitigation_actions_assigned
            columns:
              - column:
                  name: assigned_to

  - changeSet:
      id: insert-default-country-risk-data
      author: EUDR Implementation
      changes:
        - insert:
            tableName: country_risk_matrix
            columns:
              - column:
                  name: country_code
                  value: BRA
              - column:
                  name: country_name
                  value: Brazil
              - column:
                  name: risk_level
                  value: HIGH
              - column:
                  name: risk_justification
                  value: High deforestation rates in Amazon region
              - column:
                  name: last_updated
                  valueComputed: CURRENT_TIMESTAMP
              - column:
                  name: updated_by
                  value: system
        - insert:
            tableName: country_risk_matrix
            columns:
              - column:
                  name: country_code
                  value: IDN
              - column:
                  name: country_name
                  value: Indonesia
              - column:
                  name: risk_level
                  value: HIGH
              - column:
                  name: risk_justification
                  value: Significant palm oil related deforestation
              - column:
                  name: last_updated
                  valueComputed: CURRENT_TIMESTAMP
              - column:
                  name: updated_by
                  value: system
        - insert:
            tableName: country_risk_matrix
            columns:
              - column:
                  name: country_code
                  value: COD
              - column:
                  name: country_name
                  value: Democratic Republic of Congo
              - column:
                  name: risk_level
                  value: HIGH
              - column:
                  name: risk_justification
                  value: High deforestation rates in Congo Basin
              - column:
                  name: last_updated
                  valueComputed: CURRENT_TIMESTAMP
              - column:
                  name: updated_by
                  value: system
        - insert:
            tableName: country_risk_matrix
            columns:
              - column:
                  name: country_code
                  value: USA
              - column:
                  name: country_name
                  value: United States
              - column:
                  name: risk_level
                  value: LOW
              - column:
                  name: risk_justification
                  value: Strong forest protection regulations
              - column:
                  name: last_updated
                  valueComputed: CURRENT_TIMESTAMP
              - column:
                  name: updated_by
                  value: system
        - insert:
            tableName: country_risk_matrix
            columns:
              - column:
                  name: country_code
                  value: DEU
              - column:
                  name: country_name
                  value: Germany
              - column:
                  name: risk_level
                  value: LOW
              - column:
                  name: risk_justification
                  value: Comprehensive forest management and protection
              - column:
                  name: last_updated
                  valueComputed: CURRENT_TIMESTAMP
              - column:
                  name: updated_by
                  value: system